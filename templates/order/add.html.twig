{% extends 'base.html.twig' %}

{% block title %}Finalisez votre commande{% endblock %}

{% block main %}
<div class="container-fluid">
    <h4 class="text-center pt-4">Récapitulatif avant paiement</h4><br>
    <div class="row px-5">
        <div class="col-md-6">
            <ul>
                <li><strong>Numéro de commande :</strong><br>{{ order.reference }}</li>
                <li><strong>Date de commande :</strong><br>{{ order.createdAt|date('d-m-Y H:i') }}</li>
                <li><strong>Jour de livraison :</strong><br>{{ order.deliveryDay }}</li>
                <li><strong>Heure de livraison :</strong><br>{{ order.deliveryHour }}</li>
                {% set formHtml %}
                <li><strong>Adresse de livraison :</strong> <br>{{ order.deliveryAddress|raw }}</li>
                {% endset %}
                {{ formHtml|replace({'[br]' : '<br>'})|raw }}
            </ul>
        </div>
        <div class="col-md-6">
            {% for key, singleFormule in selected_formule %}
                <div class="row {% if key > 0 %}mt-2{% endif %}">
                    <div class="col-3">
                        <strong>{{ singleFormule.0.name }}</strong><br><br>
                    </div>
                    <div class="col-9">
                        <ul>
                            {% for elements in singleFormule.1 %}
                                {% for item in elements %}
                                    <li>{{ item.name }}</li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col-12">
                        <strong>Prix :</strong> {{ (singleFormule.0.price / 100)|number_format(2, ',', '.') }} €
                    </div>
                </div>
                {% if not loop.last %}
                    <hr>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script type="text/javascript">
        var stripe = Stripe("pk_test_51OqXJJGKBR4VtUNOdno4aJjdWPAraJbiGmkmcWIAtr13IdgIGakrE9NkNjQSObQhGUZ8yiYUiYElXL0DUDuCh9rG00j018z2YV");
        var checkoutButton = document.getElementById("checkout-button");
        checkoutButton.addEventListener("click", function () {
                fetch("/commande/create-session/{{ reference }}", {
                    method: "POST",
                })
                .then(function (response) {
                    return response.json();
                })
                .then(function (session) {
                    if (session.error == 'app_order') {
                        window.location.replace('{{ path('app_order') }}');
                    } else {
                        return stripe.redirectToCheckout({ sessionId: session.id });
                    }
                })
                .then(function (result) { 
                    if(result.error) {
                        alert(result.error.message);
                    }
                })
                .catch(function (error) {
                    console.error("Error:", error);
                });
        });
</script>
{% endblock %}